{% extends "base.html" %}
{% load static %}
{% block title %}{{ page_title }}{% endblock %}
{% block extra_css %}
<style>
.item-card {
    transition: transform 0.2s ease-in-out;
}
.item-card:hover {
    transform: translateY(-2px);
}
.search-filters {
    background-color: #f8f9fa;
    border-radius: 0.5rem;
    padding: 1rem;
}
</style>
{% endblock %}
{% block content %}
  <div class="container">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
      <ol class="breadcrumb">
        <li class="breadcrumb-item">
          <a href="{% url 'campaigns:detail' slug=campaign.slug %}">{{ campaign.name }}</a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">Items</li>
      </ol>
    </nav>
    
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h1 class="h2 mb-1">{{ campaign.name }} - Items</h1>
        <p class="text-muted mb-0">
          Track items, equipment, and treasures in your campaign.
          {% if items|length == 0 and not search_query and not owner_filter %}
            No items found.
          {% elif items %}
            {{ page_obj.paginator.count }} item{{ page_obj.paginator.count|pluralize }} found.
          {% endif %}
        </p>
      </div>
      {% if can_create_item %}
        <div>
          <a href="{% url 'items:create' campaign_slug=campaign.slug %}" 
             class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> Create Item
          </a>
        </div>
      {% endif %}
    </div>

    <!-- Search and Filter Form -->
    <div class="search-filters mb-4">
      <form method="get" class="row g-3 align-items-end">
        <div class="col-md-4">
          <label for="search" class="form-label">Search Items</label>
          <input type="text" 
                 class="form-control" 
                 id="search" 
                 name="search" 
                 value="{{ search_query }}"
                 placeholder="Search by name or description...">
        </div>
        <div class="col-md-3">
          <label for="owner" class="form-label">Filter by Owner</label>
          <select name="owner" id="owner" class="form-select">
            <option value="">All Items</option>
            <option value="0" {% if owner_filter == "0" %}selected{% endif %}>Unowned Items</option>
            {% for character in characters %}
              <option value="{{ character.id }}" 
                      {% if owner_filter == character.id|stringformat:"s" %}selected{% endif %}>
                {{ character.name }}
              </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <button type="submit" class="btn btn-outline-primary me-2">
            <i class="bi bi-search"></i> Filter
          </button>
          <a href="{% url 'items:campaign_items' campaign_slug=campaign.slug %}" 
             class="btn btn-outline-secondary">
            <i class="bi bi-x-circle"></i> Clear
          </a>
        </div>
      </form>
    </div>

    <!-- Items List -->
    {% if items %}
      <div class="row">
        {% for item in items %}
          <div class="col-lg-6 mb-4">
            <div class="card item-card h-100">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <h5 class="card-title mb-0">
                    <a href="{% url 'items:detail' campaign_slug=campaign.slug item_id=item.id %}" 
                       class="text-decoration-none">
                      {{ item.name }}
                    </a>
                  </h5>
                  {% if item.quantity > 1 %}
                    <span class="badge bg-primary">{{ item.quantity }}</span>
                  {% endif %}
                </div>
                
                {% if item.description %}
                  <p class="card-text text-muted">
                    {{ item.description|truncatechars:100 }}
                  </p>
                {% endif %}
                
                <div class="row text-small">
                  <div class="col-sm-6">
                    <strong>Owner:</strong>
                    {% if item.owner %}
                      <span class="text-primary">{{ item.owner.name }}</span>
                    {% else %}
                      <span class="text-muted">Unowned</span>
                    {% endif %}
                  </div>
                  <div class="col-sm-6">
                    <strong>Created by:</strong>
                    {% if item.created_by %}
                      {{ item.created_by.username }}
                    {% else %}
                      <span class="text-muted">Unknown</span>
                    {% endif %}
                  </div>
                </div>
                
                {% if can_manage_items %}
                  <div class="mt-3">
                    <div class="btn-group btn-group-sm" role="group">
                      <a href="{% url 'items:detail' campaign_slug=campaign.slug item_id=item.id %}" 
                         class="btn btn-outline-primary">
                        <i class="bi bi-eye"></i> View
                      </a>
                      <a href="{% url 'items:edit' campaign_slug=campaign.slug item_id=item.id %}" 
                         class="btn btn-outline-secondary">
                        <i class="bi bi-pencil"></i> Edit
                      </a>
                      {% if item.can_be_deleted_by:request.user %}
                        <a href="{% url 'items:delete' campaign_slug=campaign.slug item_id=item.id %}" 
                           class="btn btn-outline-danger">
                          <i class="bi bi-trash"></i> Delete
                        </a>
                      {% endif %}
                    </div>
                  </div>
                {% else %}
                  <div class="mt-3">
                    <a href="{% url 'items:detail' campaign_slug=campaign.slug item_id=item.id %}" 
                       class="btn btn-outline-primary btn-sm">
                      <i class="bi bi-eye"></i> View Details
                    </a>
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
        {% endfor %}
      </div>

      <!-- Pagination -->
      {% if is_paginated %}
        <nav aria-label="Items pagination" class="mt-4">
          <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
              <li class="page-item">
                <a class="page-link" 
                   href="?{% if search_query %}search={{ search_query }}&{% endif %}{% if owner_filter %}owner={{ owner_filter }}&{% endif %}page={{ page_obj.previous_page_number }}">
                  <i class="bi bi-chevron-left"></i> Previous
                </a>
              </li>
            {% endif %}
            
            {% for num in page_obj.paginator.page_range %}
              {% if page_obj.number == num %}
                <li class="page-item active">
                  <span class="page-link">{{ num }}</span>
                </li>
              {% else %}
                <li class="page-item">
                  <a class="page-link" 
                     href="?{% if search_query %}search={{ search_query }}&{% endif %}{% if owner_filter %}owner={{ owner_filter }}&{% endif %}page={{ num }}">
                    {{ num }}
                  </a>
                </li>
              {% endif %}
            {% endfor %}
            
            {% if page_obj.has_next %}
              <li class="page-item">
                <a class="page-link" 
                   href="?{% if search_query %}search={{ search_query }}&{% endif %}{% if owner_filter %}owner={{ owner_filter }}&{% endif %}page={{ page_obj.next_page_number }}">
                  Next <i class="bi bi-chevron-right"></i>
                </a>
              </li>
            {% endif %}
          </ul>
        </nav>
      {% endif %}
    {% else %}
      <!-- Empty State -->
      <div class="row justify-content-center">
        <div class="col-lg-8">
          <div class="card text-center">
            <div class="card-body p-5">
              {% if search_query or owner_filter %}
                <div class="mb-4">
                  <i class="bi bi-search text-muted" style="font-size: 3rem;"></i>
                  <h3 class="h4 text-muted mt-3">No Items Found</h3>
                  <p class="text-muted">
                    No items match your search criteria.
                    <a href="{% url 'items:campaign_items' campaign_slug=campaign.slug %}" 
                       class="text-decoration-none">Clear filters</a> to see all items.
                  </p>
                </div>
              {% else %}
                <div class="mb-4">
                  <i class="bi bi-box text-muted" style="font-size: 3rem;"></i>
                  <h3 class="h4 text-muted mt-3">No Items Yet</h3>
                  <p class="text-muted">
                    This campaign doesn't have any items yet.
                    {% if can_create_item %}
                      Start by creating your first item!
                    {% else %}
                      Ask the GM to add some items to get started.
                    {% endif %}
                  </p>
                </div>
              {% endif %}
              
              <div class="d-flex gap-3 justify-content-center flex-wrap">
                {% if can_create_item %}
                  <a href="{% url 'items:create' campaign_slug=campaign.slug %}" 
                     class="btn btn-primary">
                    <i class="bi bi-plus-circle"></i> Create First Item
                  </a>
                {% endif %}
                <a href="{% url 'campaigns:detail' slug=campaign.slug %}"
                   class="btn btn-secondary">
                  <i class="bi bi-arrow-left"></i> Back to Campaign
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    {% endif %}
  </div>
{% endblock %}
