{% extends "base.html" %}
{% block title %}Edit Profile - {{ block.super }}{% endblock %}
{% block content %}
  <div class="container py-4">
    <div class="row justify-content-center">
      <div class="col-lg-8">
        <div class="card shadow-sm border-0">
          <div class="card-header bg-primary text-white d-flex align-items-center py-3">
            <i class="bi bi-pencil-square me-3 fs-4"></i>
            <div>
              <h4 class="mb-0">Edit Profile</h4>
              <small class="opacity-75">Update your account settings and preferences</small>
            </div>
          </div>
          <div class="card-body p-4">
            <form method="post" novalidate>
              {% csrf_token %}
              {% if form.non_field_errors %}
                <div class="alert alert-danger d-flex align-items-center">
                  <i class="bi bi-exclamation-triangle-fill me-2"></i>
                  <div>{{ form.non_field_errors }}</div>
                </div>
              {% endif %}

              <!-- Personal Information Section -->
              <div class="mb-4">
                <h5 class="d-flex align-items-center mb-3">
                  <i class="bi bi-person me-2 text-primary"></i>Personal Information
                </h5>

                <div class="mb-3">
                  <label for="{{ form.display_name.id_for_label }}" class="form-label fw-semibold">
                    <i class="bi bi-tag me-1"></i>{{ form.display_name.label }}
                  </label>
                  <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-tag"></i></span>
                    <input type="text"
                           class="form-control {% if form.display_name.errors %}is-invalid{% endif %}"
                           name="{{ form.display_name.html_name }}"
                           id="{{ form.display_name.id_for_label }}"
                           value="{{ form.display_name.value|default:'' }}"
                           placeholder="Your preferred display name">
                    {% if form.display_name.errors %}
                      <div class="invalid-feedback">
                        {% for error in form.display_name.errors %}{{ error }}{% endfor %}
                      </div>
                    {% endif %}
                  </div>
                  {% if form.display_name.help_text %}
                    <div class="form-text">{{ form.display_name.help_text }}</div>
                  {% endif %}
                </div>

                <div class="mb-3">
                  <label for="{{ form.timezone.id_for_label }}" class="form-label fw-semibold">
                    <i class="bi bi-globe me-1"></i>{{ form.timezone.label }}
                  </label>
                  <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-globe"></i></span>
                    <select class="form-select {% if form.timezone.errors %}is-invalid{% endif %}"
                            name="{{ form.timezone.html_name }}"
                            id="{{ form.timezone.id_for_label }}">
                      {% for option in form.timezone %}
                        {{ option }}
                      {% endfor %}
                    </select>
                    {% if form.timezone.errors %}
                      <div class="invalid-feedback">
                        {% for error in form.timezone.errors %}{{ error }}{% endfor %}
                      </div>
                    {% endif %}
                  </div>
                  <div class="form-text">
                    <i class="bi bi-info-circle text-info"></i>
                    If your timezone isn't listed, it will be preserved as a custom option. All IANA timezone identifiers are supported.
                  </div>
                </div>
              </div>

              <!-- Theme Preferences Section -->
              <div class="mb-4">
                <h5 class="d-flex align-items-center mb-3">
                  <i class="bi bi-palette me-2 text-primary"></i>Theme Preferences
                </h5>

                <div class="mb-3">
                  <label for="{{ form.theme.id_for_label }}" class="form-label fw-semibold">
                    <i class="bi bi-brush me-1"></i>{{ form.theme.label }}
                  </label>

                  {% if available_themes %}
                    <!-- Enhanced Theme Selector with Preview Cards -->
                    <div class="row g-2 mt-1">
                      {% for theme in available_themes %}
                        <div class="col-md-6 col-lg-4">
                          <div class="card theme-option h-100 {% if theme.name == user_theme %}border-primary{% endif %}"
                               style="cursor: pointer;"
                               onclick="selectThemeOption('{{ theme.name }}')">
                            <div class="card-body p-3" style="background: linear-gradient(45deg, {{ theme.background_color }}, {{ theme.primary_color }}20);">
                              <div class="d-flex align-items-center justify-content-between mb-2">
                                <div class="form-check">
                                  <input class="form-check-input" type="radio"
                                         name="{{ form.theme.html_name }}"
                                         value="{{ theme.name }}"
                                         id="theme_{{ theme.name }}"
                                         {% if theme.name == user_theme %}checked{% endif %}>
                                  <label class="form-check-label fw-semibold" for="theme_{{ theme.name }}">
                                    {{ theme.display_name }}
                                  </label>
                                </div>
                                {% if theme.is_dark_theme %}
                                  <i class="bi bi-moon text-muted"></i>
                                {% else %}
                                  <i class="bi bi-sun text-muted"></i>
                                {% endif %}
                              </div>

                              <div class="d-flex align-items-center mb-2">
                                <div class="rounded-circle me-2"
                                     style="width: 10px; height: 10px; background-color: {{ theme.primary_color }};"></div>
                                <small class="text-muted">{{ theme.category|title }}</small>
                                {% if theme.is_high_contrast %}
                                  <i class="bi bi-eye ms-auto text-muted" title="High Contrast"></i>
                                {% endif %}
                              </div>

                              {% if theme.description %}
                                <p class="small text-muted mb-0">{{ theme.description|truncatewords:6 }}</p>
                              {% endif %}
                            </div>
                          </div>
                        </div>
                      {% endfor %}
                    </div>
                  {% else %}
                    <!-- Fallback to traditional select -->
                    <div class="input-group">
                      <span class="input-group-text"><i class="bi bi-palette"></i></span>
                      <select class="form-select {% if form.theme.errors %}is-invalid{% endif %}"
                              name="{{ form.theme.html_name }}"
                              id="{{ form.theme.id_for_label }}">
                        {% for option in form.theme %}
                          {{ option }}
                        {% endfor %}
                      </select>
                    </div>
                  {% endif %}

                  {% if form.theme.errors %}
                    <div class="text-danger mt-2">
                      {% for error in form.theme.errors %}{{ error }}{% endfor %}
                    </div>
                  {% endif %}

                  {% if form.theme.help_text %}
                    <div class="form-text">{{ form.theme.help_text }}</div>
                  {% endif %}
                </div>
              </div>
              <div class="d-flex gap-3 justify-content-end">
                <a href="{% url 'users:profile' %}" class="btn btn-outline-secondary">
                  <i class="bi bi-x me-1"></i>Cancel
                </a>
                <button type="submit" class="btn btn-primary">
                  <i class="bi bi-check me-1"></i>Update Profile
                </button>
              </div>
            </form>

            <hr class="my-4">

            <div class="alert alert-info d-flex align-items-center">
              <i class="bi bi-info-circle me-2"></i>
              <div>
                <strong>Note:</strong> Your username and email cannot be changed here.
                Contact an administrator if you need to change these fields.
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}
