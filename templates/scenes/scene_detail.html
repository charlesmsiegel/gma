{% extends "base.html" %}
{% load static %}
{% block title %}{{ scene.name }} - {{ campaign.name }}{% endblock %}
{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/scene-chat.css' %}">
{% endblock %}
{% block content %}
  <div class="container-fluid">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item">
          <a href="{% url 'campaigns:detail' slug=campaign.slug %}">{{ campaign.name }}</a>
        </li>
        <li class="breadcrumb-item">
          <a href="{% url 'scenes:campaign_scenes' campaign_slug=campaign.slug %}">Scenes</a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">{{ scene.name }}</li>
      </ol>
    </nav>
    <div class="row">
      <div class="col-12">
        <div class="d-flex justify-content-between align-items-start mb-4">
          <div>
            <h1 class="h2 mb-1">{{ scene.name }}</h1>
            <p class="text-muted mb-0">
              <i class="bi bi-calendar" aria-hidden="true"></i>
              Created {{ scene.created_at|date:"M j, Y" }} by {{ scene.created_by.display_name|default:scene.created_by.username }}
            </p>
          </div>
          <div class="d-flex gap-2">
            {% if can_manage_scene %}
              <a href="{% url 'scenes:scene_edit' pk=scene.pk %}"
                 class="btn btn-outline-primary">
                <i class="bi bi-pencil" aria-hidden="true"></i> Edit Scene
              </a>
            {% endif %}
            <a href="{% url 'scenes:campaign_scenes' campaign_slug=campaign.slug %}"
               class="btn btn-secondary">
              <i class="bi bi-arrow-left" aria-hidden="true"></i> Back to Scenes
            </a>
          </div>
        </div>
        <div class="row">
          <!-- Main Chat Interface -->
          <div class="col-lg-8 col-xl-9">
            <div id="scene-chat-container"></div>
          </div>
          <!-- Scene Info Sidebar -->
          <div class="col-lg-4 col-xl-3">
            <!-- Scene Information -->
            <div class="card mb-3">
              <div class="card-header">
                <h6 class="card-title mb-0">
                  <i class="bi bi-info-circle" aria-hidden="true"></i> Scene Info
                </h6>
              </div>
              <div class="card-body">
                <div class="mb-2">
                  <span class="badge
                               {% if scene.status == 'ACTIVE' %}
                                 bg-success
                               {% elif scene.status == 'CLOSED' %}
                                 bg-warning
                               {% else %}
                                 bg-secondary
                               {% endif %}">{{ scene.get_status_display }}</span>
                </div>
                {% if scene.description %}
                  <p class="small mb-3">{{ scene.description|truncatewords:20 }}</p>
                {% endif %}
                <small class="text-muted">
                  <strong>Created:</strong> {{ scene.created_at|date:"M j, Y" }}
                  <br>
                  <strong>Creator:</strong> {{ scene.created_by.display_name|default:scene.created_by.username }}
                </small>
              </div>
            </div>
            <!-- Participants -->
            <div class="card mb-3">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="card-title mb-0">
                  <i class="bi bi-people" aria-hidden="true"></i> Participants
                  <span class="badge bg-primary ms-1">{{ participants.count }}</span>
                </h6>
                {% if can_manage_scene %}
                  <button class="btn btn-sm btn-outline-primary"
                          data-bs-toggle="modal"
                          data-bs-target="#addParticipantModal"
                          title="Add Participants">
                    <i class="bi bi-person-plus" aria-hidden="true"></i>
                  </button>
                {% endif %}
              </div>
              <div class="card-body">
                {% if participants %}
                  <div class="list-group list-group-flush">
                    {% for participant in participants %}
                      <div class="list-group-item px-0 py-2 d-flex justify-content-between align-items-center">
                        <div>
                          <div class="fw-semibold">{{ participant.name }}</div>
                          <small class="text-muted">{{ participant.player_owner.display_name|default:participant.player_owner.username }}</small>
                        </div>
                        {% if can_manage_scene %}
                          <button class="btn btn-sm btn-outline-danger"
                                  onclick="removeParticipant({{ participant.pk }})"
                                  title="Remove participant">
                            <i class="bi bi-x" aria-hidden="true"></i>
                          </button>
                        {% endif %}
                      </div>
                    {% endfor %}
                  </div>
                {% else %}
                  <p class="text-muted small mb-0">No participants yet.</p>
                {% endif %}
              </div>
            </div>
            <!-- Quick Actions -->
            {% if can_manage_scene %}
              <div class="card">
                <div class="card-header">
                  <h6 class="card-title mb-0">
                    <i class="bi bi-gear" aria-hidden="true"></i> Quick Actions
                  </h6>
                </div>
                <div class="card-body">
                  <div class="d-grid gap-2">
                    <a href="{% url 'scenes:scene_edit' pk=scene.pk %}"
                       class="btn btn-sm btn-outline-primary">
                      <i class="bi bi-pencil" aria-hidden="true"></i> Edit Scene
                    </a>
                    <button class="btn btn-sm btn-outline-secondary"
                            data-bs-toggle="modal"
                            data-bs-target="#changeStatusModal">
                      <i class="bi bi-arrows-move" aria-hidden="true"></i> Change Status
                    </button>
                  </div>
                </div>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Add Participant Modal -->
  {% if can_manage_scene %}
    <div class="modal fade"
         id="addParticipantModal"
         tabindex="-1"
         aria-labelledby="addParticipantModalLabel"
         aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addParticipantModalLabel">Add Participants</h5>
            <button type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                    aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div id="add-participant-error" class="alert alert-danger d-none"></div>
            <div id="add-participant-success" class="alert alert-success d-none"></div>
            <form id="addParticipantForm">
              <div class="mb-3">
                <label for="characterSelect" class="form-label">Select Character</label>
                <select class="form-select" id="characterSelect" required>
                  <option value="">Choose a character...</option>
                </select>
                <div class="form-text">
                  Only characters from this campaign can participate in scenes.
                </div>
              </div>
              <div class="d-flex justify-content-end gap-2">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Participant</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
    <!-- Change Status Modal -->
    <div class="modal fade"
         id="changeStatusModal"
         tabindex="-1"
         aria-labelledby="changeStatusModalLabel"
         aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="changeStatusModalLabel">Change Scene Status</h5>
            <button type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                    aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div id="change-status-error" class="alert alert-danger d-none"></div>
            <div id="change-status-success" class="alert alert-success d-none"></div>
            <form id="changeStatusForm">
              <div class="mb-3">
                <label for="statusSelect" class="form-label">Scene Status</label>
                <select class="form-select" id="statusSelect" required>
                  <option value="PENDING" {% if scene.status == 'PENDING' %}selected{% endif %}>
                    Pending
                  </option>
                  <option value="ACTIVE" {% if scene.status == 'ACTIVE' %}selected{% endif %}>
                    Active
                  </option>
                  <option value="CLOSED" {% if scene.status == 'CLOSED' %}selected{% endif %}>
                    Closed
                  </option>
                </select>
                <div class="form-text">Change the current status of this scene.</div>
              </div>
              <div class="d-flex justify-content-end gap-2">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary">Update Status</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  {% endif %}
{% endblock %}
{% block extra_js %}
  <script src="{% static 'js/websocket-chat.js' %}"></script>
  <script src="{% static 'js/scene-chat.js' %}"></script>
  <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize scene chat
            const sceneChatUI = new SceneChatUI('scene-chat-container', {{ scene.id }}, {
                maxMessageHistory: 100,
                markdownEnabled: true,
                autoScroll: true,
                showTimestamps: true,
                sceneStatus: '{{ scene.status }}',
                isReadOnly: {% if scene.status == 'CLOSED' %}true{% else %}false{% endif %}
            });

            // Make it available globally for debugging
            window.sceneChatUI = sceneChatUI;

            // Initialize participant management
            initializeParticipantManagement();
        });

        function getCSRFToken() {
            // Try to get from meta tag first
            const metaToken = document.querySelector('meta[name="csrf-token"]');
            if (metaToken) {
                return metaToken.getAttribute('content');
            }

            // Try to get from cookie
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'csrftoken') {
                    return value;
                }
            }

            // Try to get from form
            const csrfInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
            if (csrfInput) {
                return csrfInput.value;
            }

            return null;
        }

        function showAlert(containerId, message, type = 'danger') {
            const container = document.getElementById(containerId);
            if (container) {
                container.textContent = message;
                container.className = `alert alert-${type}`;
                setTimeout(() => {
                    container.className = `alert alert-${type} d-none`;
                }, 5000);
            }
        }

        async function initializeParticipantManagement() {
            // Load characters for the add participant modal
            await loadAvailableCharacters();

            // Set up form handlers
            const addParticipantForm = document.getElementById('addParticipantForm');
            if (addParticipantForm) {
                addParticipantForm.addEventListener('submit', handleAddParticipant);
            }

            const changeStatusForm = document.getElementById('changeStatusForm');
            if (changeStatusForm) {
                changeStatusForm.addEventListener('submit', handleChangeStatus);
            }
        }

        async function loadAvailableCharacters() {
            try {
                // Load both characters and current scene participants
                const [charactersResponse, sceneResponse] = await Promise.all([
                    fetch('/api/characters/?campaign={{ scene.campaign.id }}', {
                        method: 'GET',
                        credentials: 'include',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': getCSRFToken()
                        }
                    }),
                    fetch('/api/scenes/{{ scene.id }}/', {
                        method: 'GET',
                        credentials: 'include',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': getCSRFToken()
                        }
                    })
                ]);

                if (charactersResponse.ok && sceneResponse.ok) {
                    const charactersData = await charactersResponse.json();
                    const sceneData = await sceneResponse.json();
                    const characterSelect = document.getElementById('characterSelect');

                    // Get IDs of characters already participating
                    const participantIds = new Set(sceneData.participants.map(p => p.id));

                    // Clear existing options except the first one
                    characterSelect.innerHTML = '<option value="">Choose a character...</option>';

                    // Filter out characters that are already participants
                    const availableCharacters = charactersData.results.filter(character =>
                        !participantIds.has(character.id)
                    );

                    if (availableCharacters.length === 0) {
                        const option = document.createElement('option');
                        option.value = '';
                        option.textContent = 'No characters available to add';
                        option.disabled = true;
                        characterSelect.appendChild(option);
                    } else {
                        // Add available character options
                        availableCharacters.forEach(character => {
                            const option = document.createElement('option');
                            option.value = character.id;
                            option.textContent = character.name;
                            characterSelect.appendChild(option);
                        });
                    }
                } else {
                    showAlert('add-participant-error', 'Failed to load characters');
                }
            } catch (error) {
                console.error('Error loading characters:', error);
                showAlert('add-participant-error', 'Error loading characters');
            }
        }

        async function handleAddParticipant(event) {
            event.preventDefault();

            const characterId = document.getElementById('characterSelect').value;
            if (!characterId) {
                showAlert('add-participant-error', 'Please select a character');
                return;
            }

            try {
                const response = await fetch('/api/scenes/{{ scene.id }}/add_participant/', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({
                        character_id: parseInt(characterId)
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showAlert('add-participant-success', data.message, 'success');
                    // Refresh character list in chat
                    if (window.sceneChatUI) {
                        window.sceneChatUI.refreshCharacters();
                    }
                    // Refresh available characters in the modal (remove newly added character)
                    await loadAvailableCharacters();
                    // Clear the form
                    document.getElementById('characterSelect').value = '';
                    // Reload page after short delay to show updated participants list
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    showAlert('add-participant-error', data.message || 'Failed to add participant');
                }
            } catch (error) {
                console.error('Error adding participant:', error);
                showAlert('add-participant-error', 'Error adding participant');
            }
        }

        async function handleChangeStatus(event) {
            event.preventDefault();

            const newStatus = document.getElementById('statusSelect').value;

            try {
                const response = await fetch('/api/scenes/{{ scene.id }}/', {
                    method: 'PATCH',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({
                        status: newStatus
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert('change-status-success', 'Status updated successfully', 'success');
                    // Reload page after short delay to show updated status
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    showAlert('change-status-error', data.message || 'Failed to update status');
                }
            } catch (error) {
                console.error('Error updating status:', error);
                showAlert('change-status-error', 'Error updating status');
            }
        }

        async function removeParticipant(participantId) {
            if (!confirm('Are you sure you want to remove this participant from the scene?')) {
                return;
            }

            try {
                const response = await fetch(`/api/scenes/{{ scene.id }}/participants/${participantId}/`, {
                    method: 'DELETE',
                    credentials: 'include',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': getCSRFToken()
                    }
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    // Reload page to show updated participants
                    window.location.reload();
                } else {
                    alert(data.message || 'Failed to remove participant');
                }
            } catch (error) {
                console.error('Error removing participant:', error);
                alert('Error removing participant');
            }
        }
  </script>
{% endblock %}
