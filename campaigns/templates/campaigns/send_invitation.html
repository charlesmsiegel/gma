{% extends "base.html" %}

{% block title %}Send Invitation - {{ campaign.name }}{% endblock %}

{% block content %}
<div class="container">
    <h1>Send Invitation</h1>
    <h2>{{ campaign.name }}</h2>

    <div class="form-group">
        <label for="user_search">User Search</label>
        <input type="text" id="user_search" name="user_search" class="form-control" placeholder="Start typing to search users...">
        <div id="search_results" class="list-group mt-2"></div>
    </div>

    <form method="post" id="invitation_form">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit" class="btn btn-primary">Send Invitation</button>
        <a href="{% url 'campaigns:manage_members' slug=campaign.slug %}" class="btn btn-secondary">Cancel</a>
    </form>
</div>

<script>
// User search functionality
document.getElementById('user_search').addEventListener('input', function() {
    var query = this.value;
    if (query.length < 2) {
        document.getElementById('search_results').innerHTML = '';
        return;
    }

    fetch("{% url 'campaigns:ajax_user_search' slug=campaign.slug %}?q=" + encodeURIComponent(query))
        .then(response => response.json())
        .then(data => {
            var resultsDiv = document.getElementById('search_results');
            resultsDiv.innerHTML = '';

            data.users.forEach(function(user) {
                var item = document.createElement('a');
                item.href = '#';
                item.className = 'list-group-item list-group-item-action';
                item.textContent = user.username + ' (' + user.email + ')';
                item.onclick = function(e) {
                    e.preventDefault();
                    // Set the selected user in the form
                    var selectField = document.getElementById('id_invited_user');
                    if (selectField) {
                        // Find and select the option
                        for (var i = 0; i < selectField.options.length; i++) {
                            if (selectField.options[i].value == user.id) {
                                selectField.selectedIndex = i;
                                break;
                            }
                        }
                    }
                    resultsDiv.innerHTML = '';
                    document.getElementById('user_search').value = user.username;
                };
                resultsDiv.appendChild(item);
            });
        });
});
</script>
{% endblock %}
