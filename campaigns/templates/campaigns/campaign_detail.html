{% extends "base.html" %}
{% load static %}
{% block title %}
  {{ campaign.name }} - {{ block.super }}
{% endblock title %}
{% block extra_css %}
  <link rel="stylesheet"
        href="{% static 'campaigns/css/campaign_detail_new.css' %}">
{% endblock extra_css %}
{% block content %}
  <!-- Hero Section -->
  <div class="campaign-hero">
    <div class="container">
      <div class="py-4 py-md-5">
        <div class="row align-items-center">
          <div class="col-lg-8">
            <h1 class="campaign-title">{{ campaign.name }}</h1>
            <div class="campaign-meta">
              <div class="meta-item">
                <i class="bi bi-person-fill"></i>
                <span>{{ campaign.owner.username }}</span>
              </div>
              {% if campaign.game_system %}
                <div class="meta-item">
                  <i class="bi bi-dice-6-fill"></i>
                  <span>{{ campaign.game_system }}</span>
                </div>
              {% endif %}
              <div class="meta-item">
                <i class="bi bi-calendar-fill"></i>
                <span>Created {{ campaign.created_at|date:"M j, Y" }}</span>
              </div>
              {% if campaign.updated_at != campaign.created_at %}
                <div class="meta-item">
                  <i class="bi bi-clock-fill"></i>
                  <span>Last Updated {{ campaign.updated_at|date:"M j, Y" }}</span>
                </div>
              {% endif %}
              <div class="meta-item">
                <i class="bi bi-people-fill"></i>
                <span>{{ campaign.memberships.count|add:1 }} member{{ campaign.memberships.count|add:1|pluralize }}</span>
              </div>
            </div>
          </div>
          <div class="col-lg-4 text-lg-end mt-3 mt-lg-0">
            <div class="campaign-badges">
              <div class="status-badge
                          {% if campaign.is_active %}
                            status-active
                          {% else %}
                            status-inactive
                          {% endif %}">
                <i class="bi
                          {% if campaign.is_active %}
                            bi-play-circle
                          {% else %}
                            bi-pause-circle
                          {% endif %}"></i>
                {{ campaign.is_active|yesno:"Active,Inactive" }}
              </div>
              <div class="visibility-badge">
                <i class="bi
                          {% if campaign.is_public %}
                            bi-globe
                          {% else %}
                            bi-lock
                          {% endif %}"></i>
                {{ campaign.is_public|yesno:"Public,Private" }}
              </div>
              {% if user.is_authenticated and user_role %}
                <div class="role-badge">
                  <i class="bi bi-person-badge"></i>
                  {{ user_role }}
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Campaign Information -->
  {% if campaign.description %}
    <div class="main-content-section info-section">
      <div class="section-header">
        <h2 class="section-title">
          <i class="bi bi-journal-text"></i>
          Campaign Information
        </h2>
      </div>
      <div class="section-content">
        <p class="mb-0 campaign-description-text">{{ campaign.description|linebreaks }}</p>
      </div>
    </div>
  {% endif %}
  <!-- Management Section -->
  {% if user.is_authenticated and is_member %}
    <div class="campaign-management">
      <div class="main-content-section">
        <div class="section-header">
          <h2 class="section-title">
            <i class="bi bi-gear-fill"></i>
            Campaign Management
          </h2>
        </div>
        <div class="section-content">
          <div class="management-grid
                      {% if user_role == 'OWNER' or user_role == 'GM' %}
                        cards-4
                      {% elif user_role == 'PLAYER' %}
                        cards-2
                      {% else %}
                        cards-2
                      {% endif %}">
            {% if user_role == "OWNER" or user_role == "GM" %}
              <!-- Full management access for owners and GMs -->
              <div class="management-card characters-card" role="article">
                <div class="card-top">
                  <div class="card-icon" aria-hidden="true">üë•</div>
                  <h3 class="card-title">Manage Characters</h3>
                </div>
                <p class="card-description">Manage player and NPC characters</p>
                <a href="{% url 'campaigns:campaign_characters' slug=campaign.slug %}"
                   class="btn btn-primary">Characters</a>
              </div>
              <div class="management-card scenes-card" role="article">
                <div class="card-top">
                  <div class="card-icon" aria-hidden="true">üé≠</div>
                  <h3 class="card-title">Manage Scenes</h3>
                </div>
                <p class="card-description">Create and manage campaign scenes</p>
                <a href="{% url 'campaigns:campaign_scenes' slug=campaign.slug %}"
                   class="btn btn-primary">Scenes</a>
              </div>
              <div class="management-card locations-card" role="article">
                <div class="card-top">
                  <div class="card-icon" aria-hidden="true">üó∫Ô∏è</div>
                  <h3 class="card-title">Manage Locations</h3>
                </div>
                <p class="card-description">Organize campaign locations and maps</p>
                <a href="{% url 'campaigns:campaign_locations' slug=campaign.slug %}"
                   class="btn btn-primary">Locations</a>
              </div>
              <div class="management-card items-card" role="article">
                <div class="card-top">
                  <div class="card-icon" aria-hidden="true">‚öîÔ∏è</div>
                  <h3 class="card-title">Manage Items</h3>
                </div>
                <p class="card-description">Track items, equipment, and treasures</p>
                <a href="{% url 'campaigns:campaign_items' slug=campaign.slug %}"
                   class="btn btn-primary">Items</a>
              </div>
            {% elif user_role == "PLAYER" %}
              <!-- Limited access for players -->
              <div class="management-card" role="article">
                <div class="card-top">
                  <div class="card-icon" aria-hidden="true">üë§</div>
                  <h3 class="card-title">My Characters</h3>
                </div>
                <p class="card-description">View and manage your characters</p>
                <a href="{% url 'campaigns:campaign_characters' slug=campaign.slug %}"
                   class="btn btn-primary">My Characters</a>
              </div>
              <div class="management-card" role="article">
                <div class="card-top">
                  <div class="card-icon" aria-hidden="true">üé≠</div>
                  <h3 class="card-title">Campaign Scenes</h3>
                </div>
                <p class="card-description">Browse and participate in scenes</p>
                <a href="{% url 'campaigns:campaign_scenes' slug=campaign.slug %}"
                   class="btn btn-primary">View Scenes</a>
              </div>
            {% elif user_role == "OBSERVER" %}
              <!-- Read-only access for observers -->
              <div class="management-card" role="article">
                <div class="card-top">
                  <div class="card-icon" aria-hidden="true">üë•</div>
                  <h3 class="card-title">View Characters</h3>
                </div>
                <p class="card-description">Browse campaign characters and stories</p>
                <a href="{% url 'campaigns:campaign_characters' slug=campaign.slug %}"
                   class="btn btn-primary">View Characters</a>
              </div>
              <div class="management-card" role="article">
                <div class="card-top">
                  <div class="card-icon" aria-hidden="true">üé≠</div>
                  <h3 class="card-title">View Scenes</h3>
                </div>
                <p class="card-description">Follow along with scenes and story</p>
                <a href="{% url 'campaigns:campaign_scenes' slug=campaign.slug %}"
                   class="btn btn-primary">View Scenes</a>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  {% endif %}
  <!-- Campaign Members -->
  {% if user.is_authenticated %}
    <div class="member-list-section">
      <div class="section-header">
        <h2 class="section-title">
          <i class="bi bi-people-fill"></i>
          Campaign Members ({{ campaign.memberships.count|add:1 }})
        </h2>
      </div>
      <div class="section-content">
        <div class="member-list">
          <!-- Campaign Owner -->
          <div class="member-item">
            <div class="member-info">
              <div class="member-name">{{ campaign.owner.username }}</div>
              <div class="member-joined">Owner since {{ campaign.created_at|date:"M j, Y" }}</div>
            </div>
            <div class="member-role role-owner">
              <i class="bi bi-crown"></i>
              Owner
            </div>
          </div>
          <!-- Other Members -->
          {% for membership in campaign.memberships.all %}
            <div class="member-item">
              <div class="member-info">
                <div class="member-name">{{ membership.user.username }}</div>
                <div class="member-joined">Joined {{ membership.joined_at|date:"M j, Y" }}</div>
              </div>
              <div class="member-role role-{{ membership.role|lower }}">
                <i class="bi
                          {% if membership.role == 'GM' %}
                            bi-person-gear
                          {% elif membership.role == 'PLAYER' %}
                            bi-person
                          {% else %}
                            bi-eye
                          {% endif %}"></i>
                {{ membership.role }}
              </div>
              {% if is_owner %}
                <div class="member-actions">
                  <button class="btn btn-sm btn-outline-primary"
                          aria-label="Change role for {{ membership.user.username }}">
                    Change Role
                  </button>
                  <button class="btn btn-sm btn-outline-danger"
                          aria-label="Remove {{ membership.user.username }} from campaign">
                    Remove
                  </button>
                </div>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      </div>
      <!-- Action Bar -->
      {% if user.is_authenticated %}
        <div class="action-bar">
          <div class="primary-actions">
            {% if is_owner %}
              <button class="btn btn-secondary" disabled>
                <i class="bi bi-pencil"></i>
                Edit Campaign
              </button>
              <a href="{% url 'campaigns:send_invitation' slug=campaign.slug %}"
                 class="btn-hero"
                 aria-label="Send invitations to new players"><i class="bi bi-person-plus"></i>Invite Users</a>
              <a href="{% url 'campaigns:manage_members' slug=campaign.slug %}"
                 class="btn btn-secondary"><i class="bi bi-people"></i>Manage Members</a>
              <a href="{% url 'campaigns:settings' slug=campaign.slug %}"
                 class="btn btn-secondary">
                <i class="bi bi-gear"></i>
                Campaign Settings
              </a>
            {% elif user_role == "GM" %}
              <button class="btn-hero" disabled>
                <i class="bi bi-plus-circle"></i>
                Create Scene
              </button>
              <button class="btn btn-secondary" disabled>
                <i class="bi bi-people"></i>
                Manage NPCs
              </button>
            {% elif user_role == "PLAYER" %}
              <button class="btn-hero" disabled>
                <i class="bi bi-person"></i>
                My Characters
              </button>
            {% elif user_role == "OBSERVER" %}
              <p class="text-muted mb-0">
                <i class="bi bi-eye me-1"></i>
                You're observing this campaign
              </p>
            {% elif not user_role %}
              <button class="btn btn-secondary" disabled>
                <i class="bi bi-door-open"></i>
                Request to Join
              </button>
            {% endif %}
          </div>
          <div class="secondary-actions">
            <a href="{% url 'campaigns:list' %}" class="btn btn-outline-secondary">
              <i class="bi bi-arrow-left"></i>
              Back to Campaigns
            </a>
          </div>
        </div>
      {% endif %}
    </div>
  {% endif %}
  <!-- Join Campaign Card (for unauthenticated users) -->
  {% if not user.is_authenticated %}
    <div class="card">
      <div class="card-header">
        <h3 class="card-title mb-0">
          <i class="bi bi-door-open me-2"></i>
          Join This Campaign
        </h3>
      </div>
      <div class="card-body">
        <p class="mb-4">
          To participate in this campaign, you need to be logged in and have appropriate permissions.
        </p>
        <div class="d-flex gap-3">
          <a href="{% url 'users:login' %}" class="btn btn-primary">
            <i class="bi bi-box-arrow-in-right me-1"></i>Login
          </a>
          <a href="{% url 'users:register' %}" class="btn btn-secondary">
            <i class="bi bi-person-plus me-1"></i>Create Account
          </a>
        </div>
      </div>
    </div>
  {% endif %}
{% endblock %}
