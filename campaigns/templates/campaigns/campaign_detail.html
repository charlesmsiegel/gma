{% extends "base.html" %}
{% load static %}
{% block title %}{{ campaign.name }} - {{ block.super }}{% endblock %}
{% block extra_css %}
  <link rel="stylesheet"
        href="{% static 'campaigns/css/campaign_detail.css' %}">
{% endblock %}
{% block content %}
  <div class="container py-4">
    <!-- Breadcrumb Navigation -->
    <nav aria-label="breadcrumb" class="mb-4">
      <ol class="breadcrumb">
        <li class="breadcrumb-item">
          <a href="{% url 'campaigns:list' %}" class="text-decoration-none">
            <i class="bi bi-journal-text me-1"></i>Campaigns
          </a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">{{ campaign.name }}</li>
      </ol>
    </nav>
    <!-- Campaign Header Card -->
    <div class="card shadow-sm border-0 mb-4 info-section">
      <div class="card-header bg-primary text-white py-4">
        <div class="row align-items-center">
          <div class="col-lg-8">
            <h1 class="mb-3">{{ campaign.name }}</h1>
            <div class="d-flex flex-wrap gap-3">
              <div class="d-flex align-items-center text-white-50">
                <i class="bi bi-person-fill me-1"></i>
                <span>{{ campaign.owner.username }}</span>
              </div>
              {% if campaign.game_system %}
                <div class="d-flex align-items-center text-white-50">
                  <i class="bi bi-dice-6-fill me-1"></i>
                  <span>{{ campaign.game_system }}</span>
                </div>
              {% endif %}
              <div class="d-flex align-items-center text-white-50">
                <i class="bi bi-calendar-fill me-1"></i>
                <span>Created {{ campaign.created_at|date:"M j, Y" }}</span>
              </div>
              {% if campaign.updated_at != campaign.created_at %}
                <div class="d-flex align-items-center text-white-50">
                  <i class="bi bi-clock-fill me-1"></i>
                  <span>Last Updated {{ campaign.updated_at|date:"M j, Y" }}</span>
                </div>
              {% endif %}
              <div class="d-flex align-items-center text-white-50">
                <i class="bi bi-people-fill me-1"></i>
                <span>{{ campaign.memberships.count|add:1 }} member{{ campaign.memberships.count|add:1|pluralize }}</span>
              </div>
            </div>
          </div>
          <div class="col-lg-4 text-lg-end mt-3 mt-lg-0">
            <div class="d-flex flex-wrap gap-2 justify-content-lg-end">
              <span class="badge
                           {% if campaign.is_active %}
                             bg-success
                           {% else %}
                             bg-warning text-dark
                           {% endif %}
                           fs-6">
                <i class="bi
                          {% if campaign.is_active %}
                            bi-play-circle
                          {% else %}
                            bi-pause-circle
                          {% endif %}
                          me-1"></i>
                {{ campaign.is_active|yesno:"Active,Inactive" }}
              </span>
              <span class="badge
                           {% if campaign.is_public %}
                             bg-info
                           {% else %}
                             bg-secondary
                           {% endif %}
                           fs-6">
                <i class="bi
                          {% if campaign.is_public %}
                            bi-globe
                          {% else %}
                            bi-lock
                          {% endif %}
                          me-1"></i>
                {{ campaign.is_public|yesno:"Public,Private" }}
              </span>
              {% if user.is_authenticated and user_role %}
                <span class="badge bg-light text-dark fs-6">
                  <i class="bi bi-person-badge me-1"></i>
                  {{ user_role }}
                </span>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Campaign Information -->
    {% if campaign.description %}
      <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-light">
          <h4 class="mb-0 d-flex align-items-center">
            <i class="bi bi-journal-text me-2 text-primary"></i>
            Campaign Information
          </h4>
        </div>
        <div class="card-body">
          <div class="text-muted">{{ campaign.description|linebreaks }}</div>
        </div>
      </div>
    {% endif %}
    <!-- Management Section -->
    {% if user.is_authenticated and is_member %}
      <div class="card shadow-sm border-0 mb-4 campaign-management">
        <div class="card-header bg-light">
          <h4 class="mb-0 d-flex align-items-center">
            <i class="bi bi-gear-fill me-2 text-primary"></i>
            Campaign Management
          </h4>
        </div>
        <div class="card-body">
          <div class="management-cards">
            {% if user_role == "OWNER" or user_role == "GM" %}
              <!-- Full management access for owners and GMs -->
              <div class="management-card characters-card">
                <div class="card-icon">üë•</div>
                <h4>Manage Characters</h4>
                <p>Manage player and NPC characters</p>
                <a href="{% url 'campaigns:campaign_characters' slug=campaign.slug %}"
                   class="btn btn-primary">Characters</a>
              </div>
              <div class="management-card scenes-card">
                <div class="card-icon">üé≠</div>
                <h4>Manage Scenes</h4>
                <p>Create and manage campaign scenes</p>
                <a href="{% url 'campaigns:campaign_scenes' slug=campaign.slug %}"
                   class="btn btn-primary">Scenes</a>
              </div>
              <div class="management-card locations-card">
                <div class="card-icon">üó∫Ô∏è</div>
                <h4>Manage Locations</h4>
                <p>Organize campaign locations and maps</p>
                <a href="{% url 'campaigns:campaign_locations' slug=campaign.slug %}"
                   class="btn btn-primary">Locations</a>
              </div>
              <div class="management-card items-card">
                <div class="card-icon">‚öîÔ∏è</div>
                <h4>Manage Items</h4>
                <p>Track items, equipment, and treasures</p>
                <a href="{% url 'campaigns:campaign_items' slug=campaign.slug %}"
                   class="btn btn-primary">Items</a>
              </div>
            {% elif user_role == "PLAYER" %}
              <!-- Limited access for players -->
              <div class="management-card">
                <div class="card-icon">üë§</div>
                <h4>My Characters</h4>
                <p>View and manage your characters</p>
                <a href="{% url 'campaigns:campaign_characters' slug=campaign.slug %}"
                   class="btn btn-primary">My Characters</a>
              </div>
              <div class="management-card">
                <div class="card-icon">üé≠</div>
                <h4>Campaign Scenes</h4>
                <p>Browse and participate in scenes</p>
                <a href="{% url 'campaigns:campaign_scenes' slug=campaign.slug %}"
                   class="btn btn-primary">View Scenes</a>
              </div>
            {% elif user_role == "OBSERVER" %}
              <!-- Read-only access for observers -->
              <div class="management-card">
                <div class="card-icon">üë•</div>
                <h4>View Characters</h4>
                <p>Browse campaign characters and stories</p>
                <a href="{% url 'campaigns:campaign_characters' slug=campaign.slug %}"
                   class="btn btn-primary">View Characters</a>
              </div>
              <div class="management-card">
                <div class="card-icon">üé≠</div>
                <h4>View Scenes</h4>
                <p>Follow along with scenes and story</p>
                <a href="{% url 'campaigns:campaign_scenes' slug=campaign.slug %}"
                   class="btn btn-primary">View Scenes</a>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    {% endif %}
    <!-- Campaign Members -->
    {% if user.is_authenticated %}
      <div class="card shadow-sm border-0 mb-4 member-list-section">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
          <h4 class="mb-0 d-flex align-items-center">
            <i class="bi bi-people-fill me-2 text-primary"></i>
            Campaign Members
            {% if member_search %}
              (Filtered)
            {% else %}
              ({{ campaign.memberships.count|add:1 }})
            {% endif %}
          </h4>
          {% if is_owner %}
            <a href="{% url 'campaigns:manage_members' slug=campaign.slug %}"
               class="btn btn-outline-primary btn-sm"><i class="bi bi-gear me-1"></i>Manage Members</a>
          {% endif %}
        </div>
        <div class="card-body">
          <div class="list-group list-group-flush">
            <!-- Campaign Owner -->
            <div class="list-group-item d-flex justify-content-between align-items-center px-0">
              <div>
                <div class="fw-semibold">{{ campaign.owner.username }}</div>
                <small class="text-muted">Owner since {{ campaign.created_at|date:"M j, Y" }}</small>
              </div>
              <span class="badge bg-warning text-dark role-owner">
                <i class="bi bi-crown me-1"></i>Owner
              </span>
            </div>
            <!-- Other Members -->
            {% for membership in filtered_memberships %}
              <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                <div>
                  <div class="fw-semibold">{{ membership.user.username }}</div>
                  <small class="text-muted">Joined {{ membership.joined_at|date:"M j, Y" }}</small>
                </div>
                <div class="d-flex align-items-center gap-2">
                  <span class="badge
                               {% if membership.role == 'GM' %}
                                 bg-success
                               {% elif membership.role == 'PLAYER' %}
                                 bg-primary
                               {% else %}
                                 bg-secondary
                               {% endif %}
                               role-{{ membership.role|lower }}">
                    <i class="bi
                              {% if membership.role == 'GM' %}
                                bi-person-gear
                              {% elif membership.role == 'PLAYER' %}
                                bi-person
                              {% else %}
                                bi-eye
                              {% endif %}
                              me-1"></i>
                    {{ membership.role }}
                  </span>
                  {% if is_owner %}
                    <div class="dropdown">
                      <button class="btn btn-outline-secondary btn-sm dropdown-toggle"
                              type="button"
                              data-bs-toggle="dropdown">Actions</button>
                      <ul class="dropdown-menu">
                        <li>
                          <a class="dropdown-item" href="#"><i class="bi bi-arrow-repeat me-1"></i>Change Role</a>
                        </li>
                        <li>
                          <hr class="dropdown-divider">
                        </li>
                        <li>
                          <a class="dropdown-item text-danger" href="#"><i class="bi bi-person-x me-1"></i>Remove</a>
                        </li>
                      </ul>
                    </div>
                  {% endif %}
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
    {% endif %}
    <!-- Action Buttons -->
    {% if user.is_authenticated %}
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center">
            <div class="d-flex flex-wrap gap-2">
              {% if is_owner %}
                <a href="{% url 'campaigns:send_invitation' slug=campaign.slug %}"
                   class="btn btn-primary"><i class="bi bi-person-plus me-1"></i>Invite Users</a>
                <a href="{% url 'campaigns:settings' slug=campaign.slug %}"
                   class="btn btn-outline-secondary">
                  <i class="bi bi-gear me-1"></i>Edit Campaign
                </a>
                <!-- Campaign Settings -->
              {% elif user_role == "GM" %}
                <button class="btn btn-success" disabled>
                  <i class="bi bi-plus-circle me-1"></i>Create Scene
                </button>
                <button class="btn btn-outline-secondary" disabled>
                  <i class="bi bi-people me-1"></i>Manage NPCs
                </button>
              {% elif user_role == "PLAYER" %}
                <a href="{% url 'campaigns:campaign_characters' slug=campaign.slug %}"
                   class="btn btn-primary">
                  <i class="bi bi-person me-1"></i>My Characters
                </a>
              {% elif user_role == "OBSERVER" %}
                <span class="text-muted">
                  <i class="bi bi-eye me-1"></i>You're observing this campaign
                </span>
              {% elif not user_role %}
                <button class="btn btn-outline-primary" disabled>
                  <i class="bi bi-door-open me-1"></i>Request to Join
                </button>
              {% endif %}
            </div>
            <a href="{% url 'campaigns:list' %}" class="btn btn-outline-secondary">
              <i class="bi bi-arrow-left me-1"></i>Back to Campaigns
            </a>
          </div>
        </div>
      </div>
    {% endif %}
    <!-- Join Campaign Card (for unauthenticated users) -->
    {% if not user.is_authenticated %}
      <div class="card shadow-sm border-0">
        <div class="card-header bg-info text-white">
          <h4 class="mb-0">
            <i class="bi bi-door-open me-2"></i>
            Join This Campaign
          </h4>
        </div>
        <div class="card-body">
          <p class="mb-4">
            To participate in this campaign, you need to be logged in and have appropriate permissions.
          </p>
          <div class="d-flex gap-3">
            <a href="{% url 'users:login' %}" class="btn btn-primary">
              <i class="bi bi-box-arrow-in-right me-1"></i>Login
            </a>
            <a href="{% url 'users:register' %}" class="btn btn-outline-primary">
              <i class="bi bi-person-plus me-1"></i>Create Account
            </a>
          </div>
        </div>
      </div>
    {% endif %}
  </div>
{% endblock %}
