{% extends "base.html" %}
{% load static %}
{% block title %}{{ campaign.name }} - {{ block.super }}{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'campaigns/css/campaign_detail.css' %}">
{% endblock %}
{% block content %}
<div class="container">
  <!-- Campaign Header -->
  <div class="card mb-4">
    <div class="card-header">
      <div class="d-flex justify-content-between align-items-start">
        <div>
          <h1 class="h2 mb-2">
            {{ campaign.name }}
            <span class="badge {% if campaign.is_public %}bg-success{% else %}bg-secondary{% endif %} ms-2">
              {% if campaign.is_public %}
                <i class="bi bi-globe"></i> Public
              {% else %}
                <i class="bi bi-lock"></i> Private
              {% endif %}
            </span>
          </h1>
          <div class="row text-muted small">
            <div class="col-md-6">
              <div><strong>Owner:</strong> {{ campaign.owner.username }}</div>
              <div><strong>System:</strong> {{ campaign.game_system|default:"Not specified" }}</div>
            </div>
            <div class="col-md-6">
              <div><strong>Created:</strong> {{ campaign.created_at|date:"M j, Y" }}</div>
              {% if campaign.updated_at != campaign.created_at %}
                <div><strong>Updated:</strong> {{ campaign.updated_at|date:"M j, Y" }}</div>
              {% endif %}
            </div>
          </div>
        </div>
        <div class="d-flex gap-2 flex-wrap">
          <span class="badge {% if campaign.is_active %}bg-success{% else %}bg-warning text-dark{% endif %}">
            {% if campaign.is_active %}
              <i class="bi bi-check-circle"></i> Active
            {% else %}
              <i class="bi bi-pause-circle"></i> Inactive
            {% endif %}
          </span>
          {% if user.is_authenticated and user_role %}
            <span class="badge bg-primary">
              <i class="bi bi-person-badge"></i> {{ user_role }}
            </span>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  <!-- Campaign Description -->
  <div class="card mb-4">
    <div class="card-header">
      <h3 class="card-title mb-0">Campaign Description</h3>
    </div>
    <div class="card-body">
      {% if campaign.description %}
        <p class="mb-0">{{ campaign.description|linebreaks }}</p>
      {% else %}
        <p class="text-muted fst-italic mb-0">No description provided yet.</p>
      {% endif %}
    </div>
  </div>

  <!-- Detailed Campaign Information -->
  <div class="card mb-4">
    <div class="card-header">
      <h3 class="card-title mb-0">Campaign Information</h3>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <div class="mb-3">
            <strong class="d-block text-muted small">Campaign Master:</strong>
            <span>{{ campaign.owner.username }}</span>
          </div>
          <div class="mb-3">
            <strong class="d-block text-muted small">Game System:</strong>
            <span>{{ campaign.game_system|default:"Not specified" }}</span>
          </div>
          <div class="mb-3">
            <strong class="d-block text-muted small">Status:</strong>
            <span class="badge {% if campaign.is_active %}bg-success{% else %}bg-warning text-dark{% endif %}">
              {% if campaign.is_active %}Active Campaign{% else %}Inactive Campaign{% endif %}
            </span>
          </div>
        </div>
        <div class="col-md-6">
          <div class="mb-3">
            <strong class="d-block text-muted small">Created:</strong>
            <span>{{ campaign.created_at|date:"F j, Y \a\t g:i A" }}</span>
          </div>
          <div class="mb-3">
            <strong class="d-block text-muted small">Last Updated:</strong>
            <span>{{ campaign.updated_at|date:"F j, Y \a\t g:i A" }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Campaign Management -->
  {% if user.is_authenticated and user_role == "OWNER" or user_role == "GM" %}
    <div class="card mb-4">
      <div class="card-header">
        <h3 class="card-title mb-0">Campaign Management</h3>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-lg-3 col-md-6 mb-3">
            <div class="card h-100 text-center">
              <div class="card-body d-flex flex-column">
                <div class="mb-3" style="font-size: 2rem;">üë•</div>
                <h5 class="card-title">Manage Characters</h5>
                <p class="card-text flex-grow-1">Manage player and NPC characters</p>
                <a href="{% url 'campaigns:campaign_characters' slug=campaign.slug %}" class="btn btn-primary">Characters</a>
              </div>
            </div>
          </div>
          <div class="col-lg-3 col-md-6 mb-3">
            <div class="card h-100 text-center">
              <div class="card-body d-flex flex-column">
                <div class="mb-3" style="font-size: 2rem;">üé≠</div>
                <h5 class="card-title">Manage Scenes</h5>
                <p class="card-text flex-grow-1">Create and manage campaign scenes</p>
                <a href="{% url 'campaigns:campaign_scenes' slug=campaign.slug %}" class="btn btn-primary">Scenes</a>
              </div>
            </div>
          </div>
          <div class="col-lg-3 col-md-6 mb-3">
            <div class="card h-100 text-center">
              <div class="card-body d-flex flex-column">
                <div class="mb-3" style="font-size: 2rem;">üó∫Ô∏è</div>
                <h5 class="card-title">Manage Locations</h5>
                <p class="card-text flex-grow-1">Organize campaign locations and maps</p>
                <a href="{% url 'campaigns:campaign_locations' slug=campaign.slug %}" class="btn btn-primary">Locations</a>
              </div>
            </div>
          </div>
          <div class="col-lg-3 col-md-6 mb-3">
            <div class="card h-100 text-center">
              <div class="card-body d-flex flex-column">
                <div class="mb-3" style="font-size: 2rem;">‚öîÔ∏è</div>
                <h5 class="card-title">Manage Items</h5>
                <p class="card-text flex-grow-1">Track items, equipment, and treasures</p>
                <a href="{% url 'campaigns:campaign_items' slug=campaign.slug %}" class="btn btn-primary">Items</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  {% elif user.is_authenticated and user_role == "PLAYER" %}
    <div class="card mb-4">
      <div class="card-header">
        <h3 class="card-title mb-0">Campaign Management</h3>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <div class="card text-center">
              <div class="card-body">
                <div class="mb-3" style="font-size: 2rem;">üë§</div>
                <h5 class="card-title">My Characters</h5>
                <p class="card-text">View and manage your characters</p>
                <a href="{% url 'campaigns:campaign_characters' slug=campaign.slug %}" class="btn btn-primary">My Characters</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  {% elif user.is_authenticated and user_role == "OBSERVER" %}
    <div class="card mb-4">
      <div class="card-header">
        <h3 class="card-title mb-0">Campaign Management</h3>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6 mb-3">
            <div class="card h-100 text-center">
              <div class="card-body d-flex flex-column">
                <div class="mb-3" style="font-size: 2rem;">üë•</div>
                <h5 class="card-title">View Characters</h5>
                <p class="card-text flex-grow-1">Browse campaign characters</p>
                <a href="{% url 'campaigns:campaign_characters' slug=campaign.slug %}" class="btn btn-primary">View Characters</a>
              </div>
            </div>
          </div>
          <div class="col-md-6 mb-3">
            <div class="card h-100 text-center">
              <div class="card-body d-flex flex-column">
                <div class="mb-3" style="font-size: 2rem;">üé≠</div>
                <h5 class="card-title">View Scenes</h5>
                <p class="card-text flex-grow-1">Browse campaign scenes</p>
                <a href="{% url 'campaigns:campaign_scenes' slug=campaign.slug %}" class="btn btn-primary">View Scenes</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  {% endif %}
  <!-- Campaign Members -->
  {% if is_member %}
    <div class="card mb-4">
      <div class="card-header">
        <h3 class="card-title mb-0">Campaign Members ({{ campaign.memberships.count|add:1 }})</h3>
      </div>
      <div class="card-body">
        <div class="list-group list-group-flush">
          <!-- Campaign Owner -->
          <div class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              <strong>{{ campaign.owner.username }}</strong>
              <div class="text-muted small">Owner since {{ campaign.created_at|date:"M j, Y" }}</div>
            </div>
            <span class="badge bg-warning text-dark">Owner</span>
          </div>
          <!-- Other Members -->
          {% for membership in campaign.memberships.all %}
            <div class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                <strong>{{ membership.user.username }}</strong>
                <div class="text-muted small">Joined {{ membership.joined_at|date:"M j, Y" }}</div>
              </div>
              <div class="d-flex gap-2 align-items-center">
                <span class="badge bg-primary">{{ membership.role }}</span>
                {% if user.is_authenticated and is_owner %}
                  <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-secondary btn-sm" title="Change role for {{ membership.user.username }}">
                      <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-outline-danger btn-sm" title="Remove {{ membership.user.username }}">
                      <i class="bi bi-x-lg"></i>
                    </button>
                  </div>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
  {% endif %}

  <!-- User Access Information -->
  {% if user.is_authenticated %}
    <div class="card mb-4">
      <div class="card-header">
        <h3 class="card-title mb-0">Your Access</h3>
      </div>
      <div class="card-body">
        {% if user_role %}
          <p class="mb-3">
            You are a <span class="badge bg-primary">{{ user_role }}</span> in this campaign.
          </p>
          {% if user_role == "OWNER" %}
            <p class="mb-0">
              As the campaign owner, you have full control over this campaign including settings, membership management, and content creation.
            </p>
          {% elif user_role == "GM" %}
            <p class="mb-0">
              As a Game Master, you can manage scenes, NPCs, and guide the story within this campaign.
            </p>
          {% elif user_role == "PLAYER" %}
            <p class="mb-0">
              As a Player, you can participate in scenes, manage your characters, and interact with the campaign world.
            </p>
          {% elif user_role == "OBSERVER" %}
            <p class="mb-0">
              As an Observer, you can view campaign content but have limited interaction privileges.
            </p>
          {% endif %}
        {% else %}
          <p class="text-muted fst-italic mb-0">You are not a member of this campaign.</p>
        {% endif %}
      </div>
    </div>
  {% endif %}

  <!-- Action Buttons -->
  <div class="d-flex gap-2 flex-wrap mb-4">
    {% if user.is_authenticated and is_owner %}
      <button class="btn btn-primary" disabled>
        <i class="bi bi-pencil"></i> Edit Campaign
      </button>
      <a href="{% url 'campaigns:send_invitation' slug=campaign.slug %}" class="btn btn-secondary">
        <i class="bi bi-person-plus"></i> Invite Users
      </a>
      <a href="{% url 'campaigns:manage_members' slug=campaign.slug %}" class="btn btn-secondary">
        <i class="bi bi-people"></i> Manage Members
      </a>
      <a href="{% url 'campaigns:settings' slug=campaign.slug %}" class="btn btn-secondary">
        <i class="bi bi-gear"></i> Campaign Settings
      </a>
    {% elif user.is_authenticated and user_role == "GM" %}
      <button class="btn btn-primary" disabled>
        <i class="bi bi-plus-circle"></i> Create Scene
      </button>
      <button class="btn btn-secondary" disabled>
        <i class="bi bi-robot"></i> Manage NPCs
      </button>
    {% elif user.is_authenticated and user_role == "PLAYER" %}
      <button class="btn btn-primary" disabled>
        <i class="bi bi-eye"></i> View Scenes
      </button>
      <button class="btn btn-secondary" disabled>
        <i class="bi bi-person"></i> My Character
      </button>
    {% elif user.is_authenticated and user_role == "OBSERVER" %}
      <button class="btn btn-primary" disabled>
        <i class="bi bi-eye"></i> View Scenes
      </button>
    {% elif user.is_authenticated %}
      <button class="btn btn-secondary" disabled>
        <i class="bi bi-door-open"></i> Request to Join
      </button>
    {% endif %}
    <a href="{% url 'campaigns:list' %}" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left"></i> Back to Campaigns
    </a>
  </div>

  <!-- Join Campaign Card (for unauthenticated users) -->
  {% if not user.is_authenticated %}
    <div class="card">
      <div class="card-header">
        <h3 class="card-title mb-0">Join This Campaign</h3>
      </div>
      <div class="card-body">
        <p class="mb-3">
          To participate in this campaign, you need to be logged in and have appropriate permissions.
        </p>
        <div class="d-flex gap-2">
          <a href="{% url 'users:login' %}" class="btn btn-primary">
            <i class="bi bi-box-arrow-in-right"></i> Login
          </a>
          <a href="{% url 'users:register' %}" class="btn btn-secondary">
            <i class="bi bi-person-plus"></i> Create Account
          </a>
        </div>
      </div>
    </div>
  {% endif %}
</div>
{% endblock %}
